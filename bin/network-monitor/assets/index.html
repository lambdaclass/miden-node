<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Miden Network Monitor</title>
    <link rel="stylesheet" href="/assets/index.css">
    <link rel="icon" href="/assets/favicon.ico" type="image/x-icon">
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="logo">
                <div class="logo-icon"></div>
                <div class="logo-text">Miden <span class="highlight">Network</span></div>
            </div>
        </div>

        <div class="main-content">
            <div class="form-title">Network Status Dashboard</div>

            <div id="status-container">
                <div class="loading-section">
                    <div class="loader"></div>
                </div>
            </div>

            <div class="note">
                Last updated: <span id="last-updated">-</span>
            </div>
        </div>
    </div>

    <div class="footer">
        <div class="footer-content">
            <div class="footer-section">
                <div class="footer-label">Network Status</div>
                <div class="footer-value" id="overall-status">Checking...</div>
            </div>
            <div class="footer-section tokens-section">
                <div class="footer-label">Services</div>
                <div class="footer-value" id="services-count">-</div>
            </div>
        </div>
        <div class="footer-line"></div>
    </div>

    <script>
        let statusData = null;
        let updateInterval = null;
        const EXPLORER_LAG_TOLERANCE = 20; // max allowed block delta vs RPC, roughly 1 minute
        const COPY_ICON = `
            <svg class="copy-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
            </svg>
        `;

        function renderCopyButton(value, label) {
            if (!value) return '';
            const escapedValue = JSON.stringify(value);
            return `
                <button class="copy-button" onclick="copyToClipboard(${escapedValue}, event)" title="Copy full ${label}">
                    ${COPY_ICON}
                </button>
            `;
        }

        function formatSuccessRate(successCount, failureCount) {
            const total = successCount + failureCount;
            if (!total) {
                return 'N/A';
            }

            return `${((successCount / total) * 100).toFixed(1)}%`;
        }

        async function fetchStatus() {
            try {
                const response = await fetch('/status');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                statusData = await response.json();
                updateDisplay();
            } catch (error) {
                console.error('Error fetching status:', error);
                showError('Failed to fetch network status: ' + error.message);
            }
        }

        // Merge Remote Prover status and test entries into a single card per prover.
        function mergeProverStatusAndTests(services) {
            const testsByName = new Map();
            const merged = [];
            const usedTests = new Set();

            services.forEach(service => {
                if (service.details && service.details.RemoteProverTest) {
                    testsByName.set(service.name, service);
                }
            });

            services.forEach(service => {
                if (service.details && service.details.RemoteProverStatus) {
                    const test = testsByName.get(service.name);
                    if (test) {
                        usedTests.add(service.name);
                    }
                    merged.push({
                        ...service,
                        testDetails: test?.details?.RemoteProverTest ?? null,
                        testStatus: test?.status ?? null,
                        testError: test?.error ?? null
                    });
                } else if (!(service.details && service.details.RemoteProverTest)) {
                    // Non-prover entries pass through unchanged
                    merged.push(service);
                }
            });

            // Add orphaned tests (in case a test arrives before a status)
            testsByName.forEach((test, name) => {
                if (!usedTests.has(name)) {
                    merged.push({
                        name,
                        status: test.status,
                        last_checked: test.last_checked,
                        error: test.error,
                        details: null,
                        testDetails: test.details.RemoteProverTest,
                        testStatus: test.status,
                        testError: test.error
                    });
                }
            });

            return merged;
        }

        function updateDisplay() {
            if (!statusData) return;

            const container = document.getElementById('status-container');
            const lastUpdated = document.getElementById('last-updated');
            const overallStatus = document.getElementById('overall-status');
            const servicesCount = document.getElementById('services-count');

            // Update last updated time
            const lastUpdateTime = new Date(statusData.last_updated * 1000);
            lastUpdated.textContent = lastUpdateTime.toLocaleString();

            // Group remote prover status + test into single cards
            const processedServices = mergeProverStatusAndTests(statusData.services);
            const rpcService = processedServices.find(s => s.details && s.details.RpcStatus);
            const rpcChainTip =
                rpcService?.details?.RpcStatus?.store_status?.chain_tip ??
                rpcService?.details?.RpcStatus?.block_producer_status?.chain_tip ??
                null;

            // Count healthy vs unhealthy services
            const healthyServices = processedServices.filter(s => s.status === 'Healthy').length;
            const totalServices = processedServices.length;
            const allHealthy = healthyServices === totalServices;

            // Update footer
            overallStatus.textContent = allHealthy ? 'All Systems Operational' : `${healthyServices}/${totalServices} Services Healthy`;
            overallStatus.style.color = allHealthy ? '#22C55D' : '#ff5500';
            servicesCount.textContent = `${totalServices} Services`;

            // Generate status cards
            const serviceCardsHtml = processedServices.map(service => {
                const isHealthy = service.status === 'Healthy';
                const statusColor = isHealthy ? '#22C55D' : '#ff5500';
                const statusIcon = isHealthy ? '✓' : '✗';
                const numOrDash = value => isHealthy ? (value?.toLocaleString?.() ?? value ?? '-') : '-';
                const timeOrDash = ts => {
                    if (!isHealthy) return '-';
                    return ts ? new Date(ts * 1000).toLocaleString() : '-';
                };
                const commitmentOrDash = (value, label) => isHealthy && value
                    ? `
                        ${value.substring(0, 20)}...
                        ${renderCopyButton(value, label)}
                    `
                    : '-';

                const explorerStats = service.details?.ExplorerStatus;
                const isExplorerService = service.name?.toLowerCase().includes('explorer');
                const deltaBlock = (isHealthy && explorerStats && rpcChainTip !== null)
                    ? explorerStats.block_number - rpcChainTip
                    : null;
                const deltaWarning =
                    deltaBlock !== null && Math.abs(deltaBlock) > EXPLORER_LAG_TOLERANCE
                        ? `Explorer tip is ${Math.abs(deltaBlock)} blocks ${deltaBlock > 0 ? 'ahead' : 'behind'}`
                        : null;
                let explorerWarningHtml = '';

                let detailsHtml = '';
                if (service.details) {
                    const details = service.details;
                    detailsHtml = `
                        <div class="service-details">
                            ${details.RpcStatus ? `
                                <div class="detail-item"><strong>Version:</strong> ${details.RpcStatus.version}</div>
                                ${details.RpcStatus.genesis_commitment ? `
                                    <div class="detail-item">
                                        <strong>Genesis:</strong>
                                        <span class="genesis-value">0x${details.RpcStatus.genesis_commitment.substring(0, 20)}...</span>
                                        ${renderCopyButton(details.RpcStatus.genesis_commitment, 'genesis commitment')}
                                    </div>
                                ` : ''}
                                ${details.RpcStatus.store_status ? `
                                    <div class="nested-status">
                                        <div class="detail-item"><strong>Store</strong></div>
                                        <div class="metric-row">
                                            <span class="metric-label">Version:</span>
                                            <span class="metric-value">${details.RpcStatus.store_status.version}</span>
                                        </div>
                                        <div class="metric-row">
                                            <span class="metric-label">Status:</span>
                                            <span class="metric-value">${details.RpcStatus.store_status.status}</span>
                                        </div>
                                        <div class="metric-row">
                                            <span class="metric-label">Chain Tip:</span>
                                            <span class="metric-value">${details.RpcStatus.store_status.chain_tip}</span>
                                        </div>
                                    </div>
                                ` : ''}
                                ${details.RpcStatus.block_producer_status ? `
                                    <div class="nested-status">
                                        <div class="detail-item"><strong>Block Producer</strong></div>
                                        <div class="metric-row">
                                            <span class="metric-label">Version:</span>
                                            <span class="metric-value">${details.RpcStatus.block_producer_status.version}</span>
                                        </div>
                                        <div class="metric-row">
                                            <span class="metric-label">Status:</span>
                                            <span class="metric-value">${details.RpcStatus.block_producer_status.status}</span>
                                        </div>
                                        <div class="metric-row">
                                            <span class="metric-label">Chain Tip:</span>
                                            <span class="metric-value">${details.RpcStatus.block_producer_status.chain_tip}</span>
                                        </div>
                                        <div class="nested-status mempool-stats">
                                            <strong>Mempool stats:</strong>
                                            <div class="metric-row">
                                                <span class="metric-label">Unbatched TXs:</span>
                                                <span class="metric-value">${details.RpcStatus.block_producer_status.mempool.unbatched_transactions}</span>
                                            </div>
                                            <div class="metric-row">
                                                <span class="metric-label">Proposed Batches:</span>
                                                <span class="metric-value">${details.RpcStatus.block_producer_status.mempool.proposed_batches}</span>
                                            </div>
                                            <div class="metric-row">
                                                <span class="metric-label">Proven Batches:</span>
                                                <span class="metric-value">${details.RpcStatus.block_producer_status.mempool.proven_batches}</span>
                                            </div>
                                        </div>
                                    </div>
                                ` : ''}
                            ` : ''}
                            ${details.RemoteProverStatus ? `
                                <div class="nested-status">
                                    <strong>Prover Status (${details.RemoteProverStatus.url}):</strong>
                                    <div class="detail-item"><strong>Version:</strong> ${details.RemoteProverStatus.version}</div>
                                    <div class="nested-status">
                                        <strong>Supported Proof Type:</strong> ${details.RemoteProverStatus.supported_proof_type}
                                    </div>
                                    ${details.RemoteProverStatus.workers && details.RemoteProverStatus.workers.length > 0 ? `
                                        <div class="nested-status">
                                            <strong>Workers (${details.RemoteProverStatus.workers.length}):</strong>
                                            ${details.RemoteProverStatus.workers.map(worker => `
                                                <div class="worker-status">
                                                    <span class="worker-name">${worker.name}</span> -
                                                    <span class="worker-version">${worker.version}</span> -
                                                    <span class="worker-status-badge ${worker.status === 'Healthy' ? 'healthy' : worker.status === 'Unhealthy' ? 'unhealthy' : 'unknown'}">${worker.status}</span>
                                                </div>
                                            `).join('')}
                                        </div>
                                    ` : ''}
                                </div>
                            ` : ''}
                            ${details.FaucetTest ? `
                                <div class="nested-status">
                                    <strong>Faucet:</strong>
                                    <div class="test-metrics ${service.status === 'Healthy' ? 'healthy' : 'unhealthy'}">
                                        <div class="metric-row">
                                            <span class="metric-label">Success Rate:</span>
                                            <span class="metric-value">${formatSuccessRate(details.FaucetTest.success_count, details.FaucetTest.failure_count)}</span>
                                        </div>
                                        <div class="metric-row">
                                            <span class="metric-label">Last Response Time:</span>
                                            <span class="metric-value">${details.FaucetTest.test_duration_ms}ms</span>
                                        </div>
                                        ${details.FaucetTest.last_tx_id ? `
                                            <div class="metric-row">
                                                <span class="metric-label">Last TX ID:</span>
                                                <span class="metric-value">${details.FaucetTest.last_tx_id.substring(0, 16)}...${renderCopyButton(details.FaucetTest.last_tx_id, 'TX ID')}</span>
                                            </div>
                                        ` : ''}
                                        ${details.FaucetTest.challenge_difficulty ? `
                                            <div class="metric-row">
                                                <span class="metric-label">Last Challenge Difficulty:</span>
                                                <span class="metric-value">~${details.FaucetTest.challenge_difficulty} bits</span>
                                            </div>
                                        ` : ''}
                                    </div>
                                </div>
                                ${details.FaucetTest.faucet_metadata ? `
                                    <div class="nested-status">
                                        <strong>Faucet Token Info:</strong>
                                        <div class="test-metrics ${service.status === "Healthy" ? "healthy" : "unhealthy"}">
                                            <div class="metric-row">
                                                <span class="metric-label">Token ID:</span>
                                                <span class="metric-value">${details.FaucetTest.faucet_metadata.id.substring(0, 16)}...${renderCopyButton(details.FaucetTest.faucet_metadata.id, 'token ID')}</span>
                                            </div>
                                            <div class="metric-row">
                                                <span class="metric-label">Version:</span>
                                                <span class="metric-value">${details.FaucetTest.faucet_metadata.version || '-'}</span>
                                            </div>
                                            <div class="metric-row">
                                                <span class="metric-label">Current Issuance:</span>
                                                <span class="metric-value">${details.FaucetTest.faucet_metadata.issuance.toLocaleString()}</span>
                                            </div>
                                            <div class="metric-row">
                                                <span class="metric-label">Max Supply:</span>
                                                <span class="metric-value">${details.FaucetTest.faucet_metadata.max_supply.toLocaleString()}</span>
                                            </div>
                                            <div class="metric-row">
                                                <span class="metric-label">Decimals:</span>
                                                <span class="metric-value">${details.FaucetTest.faucet_metadata.decimals}</span>
                                            </div>
                                            <div class="metric-row">
                                                <span class="metric-label">Base Amount:</span>
                                                <span class="metric-value">${details.FaucetTest.faucet_metadata.base_amount.toLocaleString()}</span>
                                            </div>
                                            <div class="metric-row">
                                                <span class="metric-label">PoW Difficulty:</span>
                                                <span class="metric-value">${details.FaucetTest.faucet_metadata.pow_load_difficulty}</span>
                                            </div>
                                            <div class="metric-row">
                                                <span class="metric-label">Explorer URL:</span>
                                                <span class="metric-value">
                                                    <a href="${details.FaucetTest.faucet_metadata.explorer_url}" target="_blank" rel="noopener noreferrer">
                                                        ${details.FaucetTest.faucet_metadata.explorer_url}
                                                    </a>
                                                </span>
                                            </div>
                                        </div>
                                    </div>
                                  ` : ''}
                            ` : ''}
                            ${details.NtxIncrement ? `
                                <div class="nested-status">
                                    <strong>Local Transactions:</strong>
                                    <div class="test-metrics ${service.status === 'Healthy' ? 'healthy' : 'unhealthy'}">
                                        <div class="metric-row">
                                            <span class="metric-label">Success Rate:</span>
                                            <span class="metric-value">${formatSuccessRate(details.NtxIncrement.success_count, details.NtxIncrement.failure_count)}</span>
                                        </div>
                                        ${details.NtxIncrement.last_latency_blocks !== null && details.NtxIncrement.last_latency_blocks !== undefined ? `
                                            <div class="metric-row">
                                                <span class="metric-label">Latency:</span>
                                                <span class="metric-value">${details.NtxIncrement.last_latency_blocks} blocks</span>
                                            </div>
                                        ` : ''}
                                        ${details.NtxIncrement.last_tx_id ? `
                                            <div class="metric-row">
                                                <span class="metric-label">Last TX ID:</span>
                                                <span class="metric-value">${details.NtxIncrement.last_tx_id.substring(0, 16)}...${renderCopyButton(details.NtxIncrement.last_tx_id, 'TX ID')}</span>
                                            </div>
                                        ` : ''}
                                    </div>
                                </div>
                            ` : ''}
                            ${details.NtxTracking ? `
                                <div class="nested-status">
                                    <strong>Network Transactions:</strong>
                                    <div class="test-metrics ${service.status === 'Healthy' ? 'healthy' : 'unhealthy'}">
                                        <div class="metric-row">
                                            <span class="metric-label">Current Value:</span>
                                            <span class="metric-value">${details.NtxTracking.current_value ?? '-'}</span>
                                        </div>
                                        ${details.NtxTracking.expected_value ? `
                                            <div class="metric-row">
                                                <span class="metric-label">Expected Value:</span>
                                                <span class="metric-value">${details.NtxTracking.expected_value}</span>
                                            </div>
                                        ` : ''}
                                        ${details.NtxTracking.pending_increments !== null && details.NtxTracking.pending_increments !== undefined ? `
                                            <div class="metric-row">
                                                <span class="metric-label">Pending Notes:</span>
                                                <span class="metric-value">${details.NtxTracking.pending_increments}</span>
                                            </div>
                                        ` : ''}
                                        ${details.NtxTracking.last_updated ? `
                                            <div class="metric-row">
                                                <span class="metric-label">Last Updated:</span>
                                                <span class="metric-value">${new Date(details.NtxTracking.last_updated * 1000).toLocaleString()}</span>
                                            </div>
                                        ` : ''}
                                    </div>
                                </div>
                            ` : ''}
                            ${service.testDetails ? `
                                <div class="nested-status">
                                    <strong>Proof Generation Testing (${service.testDetails.proof_type}):</strong>
                                    <div class="test-metrics ${service.testStatus === 'Healthy' ? 'healthy' : 'unhealthy'}">
                                        <div class="metric-row">
                                            <span class="metric-label">Success Rate:</span>
                                            <span class="metric-value">${formatSuccessRate(service.testDetails.success_count, service.testDetails.failure_count)}</span>
                                        </div>
                                        <div class="metric-row">
                                            <span class="metric-label">Last Response Time:</span>
                                            <span class="metric-value">${service.testDetails.test_duration_ms}ms</span>
                                        </div>
                                        <div class="metric-row">
                                            <span class="metric-label">Last Proof Size:</span>
                                            <span class="metric-value">${(service.testDetails.proof_size_bytes / 1024).toFixed(2)} KB</span>
                                        </div>
                                    </div>
                                </div>
                            ` : ''}
                        </div>
                    `;
                }

                // Always render explorer block for explorer services, even if stats are missing.
                if (isExplorerService) {
                    detailsHtml += `
                        <div class="service-details">
                            <div class="nested-status">
                                <strong>Explorer:</strong>
                                <div class="metric-row">
                                    <span class="metric-label">Block Height:</span>
                                    <span class="metric-value">${explorerStats ? numOrDash(explorerStats.block_number) : '-'}</span>
                                </div>
                                <div class="metric-row">
                                    <span class="metric-label">RPC Chain Tip:</span>
                                    <span class="metric-value">${isHealthy && rpcChainTip !== null ? rpcChainTip : '-'}</span>
                                </div>
                                <div class="metric-row">
                                    <span class="metric-label">Block Time:</span>
                                    <span class="metric-value">${explorerStats ? timeOrDash(explorerStats.timestamp) : '-'}</span>
                                </div>
                                <div class="metric-row">
                                    <span class="metric-label">Block Commitment:</span>
                                    <span class="metric-value">${explorerStats ? commitmentOrDash(explorerStats.block_commitment, 'block commitment') : '-'}</span>
                                </div>
                                <div class="metric-row">
                                    <span class="metric-label">Chain Commitment:</span>
                                    <span class="metric-value">${explorerStats ? commitmentOrDash(explorerStats.chain_commitment, 'chain commitment') : '-'}</span>
                                </div>
                                <div class="metric-row">
                                    <span class="metric-label">Proof Commitment:</span>
                                    <span class="metric-value">${explorerStats ? commitmentOrDash(explorerStats.proof_commitment, 'proof commitment') : '-'}</span>
                                </div>
                                <div class="metric-row">
                                    <span class="metric-label">Transactions:</span>
                                    <span class="metric-value">${explorerStats ? numOrDash(explorerStats.number_of_transactions) : '-'}</span>
                                </div>
                                <div class="metric-row">
                                    <span class="metric-label">Nullifiers:</span>
                                    <span class="metric-value">${explorerStats ? numOrDash(explorerStats.number_of_nullifiers) : '-'}</span>
                                </div>
                                <div class="metric-row">
                                    <span class="metric-label">Notes:</span>
                                    <span class="metric-value">${explorerStats ? numOrDash(explorerStats.number_of_notes) : '-'}</span>
                                </div>
                                <div class="metric-row">
                                    <span class="metric-label">Account Updates:</span>
                                    <span class="metric-value">${explorerStats ? numOrDash(explorerStats.number_of_account_updates) : '-'}</span>
                                </div>
                            </div>
                        </div>
                    `;

                    if (deltaWarning) {
                        explorerWarningHtml = `
                            <div class="warning-banner">
                                <div class="metric-row">
                                    <span class="metric-label">Explorer vs RPC</span>
                                </div>
                                <div class="warning-text">${deltaWarning}</div>
                            </div>
                        `;
                    }
                }

                return `
                    <div class="service-card ${isHealthy ? 'healthy' : 'unhealthy'}">
                        <div class="service-header">
                            <div class="service-name">${service.name}</div>
                            <div class="service-status" style="color: ${statusColor}">
                                ${statusIcon} ${service.status.toUpperCase()}
                            </div>
                        </div>
                        <div class="service-content">
                            ${detailsHtml}
                            ${explorerWarningHtml}
                        </div>
                        <div class="service-timestamp">
                            Last checked: ${new Date(service.last_checked * 1000).toLocaleString()}
                        </div>
                    </div>
                `;
            }).join('');

            container.innerHTML = serviceCardsHtml;

            // Add refresh button that spans the full grid
            container.innerHTML += `
                <div class="refresh-button-container">
                    <button class="button" onclick="fetchStatus()">
                        <svg class="button-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M23 4v6h-6M1 20v-6h6M20.49 9A9 9 0 0 0 5.64 5.64L1 10m22 4l-4.64 4.36A9 9 0 0 1 3.51 15"/>
                        </svg>
                        Refresh Status
                    </button>
                </div>
            `;
        }

        function showError(message) {
            const container = document.getElementById('status-container');
            container.innerHTML = `
                <div class="error-message" style="display: block;">
                    ${message}
                </div>
                <div class="refresh-button-container">
                    <button class="button" onclick="fetchStatus()">
                        <svg class="button-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M23 4v6h-6M1 20v-6h6M20.49 9A9 9 0 0 0 5.64 5.64L1 10m22 4l-4.64 4.36A9 9 0 0 1 3.51 15"/>
                        </svg>
                        Retry
                    </button>
                </div>
            `;
        }

        async function copyToClipboard(text, event) {
            try {
                await navigator.clipboard.writeText(text);
                // Show a brief success indicator
                const button = event.target.closest('.copy-button');
                const originalContent = button.innerHTML;
                button.innerHTML = '<svg class="copy-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 6L9 17l-5-5"/></svg>';
                button.style.color = '#22C55D';

                setTimeout(() => {
                    button.innerHTML = originalContent;
                    button.style.color = '';
                }, 2000);
            } catch (err) {
                console.error('Failed to copy: ', err);
                // Fallback for older browsers
                const textArea = document.createElement('textarea');
                textArea.value = text;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
            }
        }

        // Initial load and set up auto-refresh
        fetchStatus();
        updateInterval = setInterval(fetchStatus, 10000); // Refresh every 10 seconds

        // Clean up on page unload
        window.addEventListener('beforeunload', () => {
            if (updateInterval) {
                clearInterval(updateInterval);
            }
        });
    </script>
</body>
</html>
